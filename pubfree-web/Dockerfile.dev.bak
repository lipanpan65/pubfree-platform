# PubFree Web - 开发环境 Dockerfile
# 支持跨平台构建，解决 Rollup 架构问题
FROM --platform=$BUILDPLATFORM node:20.19.0-slim AS base

# 接收构建参数
ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG TARGETOS
ARG TARGETARCH

# 显示构建信息
RUN echo "Building web on $BUILDPLATFORM for $TARGETPLATFORM" && \
    echo "Target OS: $TARGETOS, Target Arch: $TARGETARCH"

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    curl \
    git \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 设置 npm 配置以支持跨平台
RUN npm config set target_platform ${TARGETOS:-linux} && \
    npm config set target_arch ${TARGETARCH:-x64} && \
    npm config set cache /tmp/.npm && \
    npm config set python python3

# 复制 package 文件
COPY package*.json ./

# 清理可能的架构冲突并安装依赖
RUN rm -rf node_modules package-lock.json && \
    npm install --force --no-optional

# 复制源代码
COPY . .

# 设置环境变量
ENV NODE_ENV=development \
    VITE_ENV=development \
    NODE_OPTIONS=--max-old-space-size=4096

# 暴露端口
EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

# 启动命令
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "3000"]